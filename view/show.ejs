<% layout('layouts/boilerplate') %>

<div class="container my-5 listing-detail">
  <h1 class="mb-4"><%= listing.title %></h1>
  <img src="<%= listing.image.url %>" alt="<%= listing.title %>" class="img-fluid rounded mb-4" style="max-width: 100%; max-height: 500px; object-fit: cover;">
  <p><strong>Price:</strong> ₹<%= listing.price.toLocaleString("en-IN") %></p>
  <div class="card border-info mb-4" style="max-width: 400px;">
    <div class="card-header bg-info text-white">
      Owner Information
    </div>
    <div class="card-body">
      <h5 class="card-title"><%= listing.owner?.username || "Unknown" %></h5>
      <p class="card-text"><strong>Email:</strong> <%= listing.owner?.email || "Not provided" %></p>
    </div>
  </div>
  <p><strong>Description:</strong> <%= listing.description %></p>
  <p><strong>Location:</strong> <%= listing.location %>, <%= listing.country %></p>
  <div class="mt-4 d-flex gap-3 flex-wrap">
    <a href="/listings" class="btn btn-secondary">← Back to listings</a>
    <% if (currentUser && listing.owner && currentUser._id.toString() === listing.owner._id.toString()) { %>
      <form action="/listings/<%= listing._id %>?_method=DELETE" method="POST" onsubmit="return confirm('Are you sure you want to delete this listing?');" style="display:inline;">
        <button type="submit" class="btn btn-danger">Delete</button>
      </form>
      <a href="/listings/<%= listing._id %>/edit" class="btn btn-primary">Edit</a>
    <% } %>
  </div>
</div>

<hr class="my-5">

<div class="container">
 <h3 class="mb-3">Reviews</h3>
<% if (listing.reviews && listing.reviews.length > 0) { %>
  <ul class="list-group mb-4">
    <% listing.reviews.forEach(review => { %>
      <li class="list-group-item">
        <strong>Author:</strong> <%= review.author?.username || "Unknown" %><br>
        <h6 class="mt-2 mb-1">Rating:</h6>
        <p class="starability-result" data-rating="<%= review.ratting %>">
          Rated: <%= review.ratting %> stars
        </p>
        <strong>Comment:</strong> <%= review.comment %><br>
        <small class="text-muted">Posted on <%= new Date(review.createdAt).toLocaleDateString() %></small>
        <% if (currentUser && review.author && currentUser._id.toString() === review.author._id.toString()) { %>
          <form action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE" method="POST" onsubmit="return confirm('Are you sure you want to delete this review?');" class="d-inline float-end">
            <input type="hidden" name="_method" value="DELETE">
            <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
          </form>
        <% } %>
      </li>
    <% }); %>
  </ul>
<% } else { %>
  <p class="text-muted">No reviews yet.</p>
<% } %>

<h4>Add a Review</h4>

<% if (currentUser) { %>
<form action="/listings/<%= listing._id %>/reviews" method="POST" class="mb-5 needs-validation" novalidate>
  <!-- <div class="mb-3">
    <label for="ratting" class="form-label">Rating (1-5)</label>
    <input type="number" id="ratting" name="review[ratting]" class="form-control" min="1" max="5" required>
    <div class="invalid-feedback">
      Please enter a rating between 1 and 5.
    </div>
  </div> -->
  <fieldset class="starability-slot">
  <legend>First rating:</legend>
  <input type="radio" id="no-rate" class="input-no-rate" name="review[ratting]" value="0" checked aria-label="No rating." />
  <input type="radio" id="first-rate1" name="review[ratting]" value="1" />
  <label for="first-rate1" title="Terrible">1 star</label>
  <input type="radio" id="first-rate2" name="review[ratting]" value="2" />
  <label for="first-rate2" title="Not good">2 stars</label>
  <input type="radio" id="first-rate3" name="review[ratting]" value="3" />
  <label for="first-rate3" title="Average">3 stars</label>
  <input type="radio" id="first-rate4" name="review[ratting]" value="4" />
  <label for="first-rate4" title="Very good">4 stars</label>
  <input type="radio" id="first-rate5" name="review[ratting]" value="5" />
  <label for="first-rate5" title="Amazing">5 stars</label>
</fieldset>
  <div class="mb-3">
    <label for="comment" class="form-label">Comment</label>
    <textarea id="comment" name="review[comment]" class="form-control" rows="3" required minlength="5"></textarea>
    <div class="invalid-feedback">
      Please enter a comment with at least 5 characters.
    </div>
  </div>
  <button type="submit" class="btn btn-success">Submit Review</button>
</form>
<% } else { %>
  <div class="alert alert-warning mb-5">
    You must <a href="/user/login">log in</a> to post a review.
  </div>
<% } %>
</div>
